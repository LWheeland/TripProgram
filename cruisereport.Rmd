---

title: DFO Multispecies Survey Trip Report
subtitle: Newfoundland and Labrador Region
author: "Science Branch"
output: pdf_document
# output: html_document
# End of options to set
knit: bookdown::render_book
site: bookdown::bookdown_site
link-citations: true
bibliography: bib/refs.bib
csl: csl/csas.csl
lot: true
lof: true

---

```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
# adjust as desired:
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = if (knitr:::is_latex_output()) "knitr-figs-pdf/" else "knitr-figs-docx/",
  cache.path = if (knitr:::is_latex_output()) "knitr-cache-tex/" else "knitr-cache-docx/",
  fig.asp = 0.618,
  fig.width = 9,
  out.width = "6in",
  echo = FALSE,
#  autodep = TRUE,
#  cache = TRUE,
  cache.comments = FALSE,
  dev = if (knitr:::is_latex_output()) "png" else "png",
  dpi = 180,
  fig.align = "center",
  fig.pos = "htb"
)
```

# ```{r load-libraries, cache=FALSE}
# # add other packages here:
# library(csasdown)
# ```

```{r trip.settings, echo=FALSE}
#BR Added the below and commented out the rest...
library(svDialogs)
library(svGUI)
dfo_fill<-function(){
  res<-list()
  res["PIC"] <- dlg_input("Name of Person in Charge")$res
  res["Vessel.abb"] <- dlg_input("Vessel (ex: TEL)")$res
  if(res["Vessel.abb"]=="TEL"){
    res["Vessel"]<-"Teleost"
  }else{
    res["Vessel"]<-"Alfred Needler"
  }
  res["Trip"] <- dlg_input("Trip (eg. 190)")$res
  res["Start"]<- dlg_input("Start Date (eg. 01 September 2018)")$res
  res["End"]<- dlg_input("End Date (eg. 01 September 2018)")$res
  res["Crew"]<- dlg_input("Scientific Crew (eg. B. Rogers, D. Who)")$res
  res["H_lost"]<- dlg_input("Hours Lost")$res
  
  res
}
trip_sum<-dfo_fill()
```

```{r data.summary, include=FALSE}
library(tidyverse)
library(foreign)

#  read in species codes     
spp_codes <- read_csv("Data/species codes (lookup).csv")
spp_codes$code <- as.numeric(spp_codes$Spc_Code)

#  read in FFS data dbf      
RV.SET <- read.dbf("Data/RV_SET.dbf")
RV.Catch <- read.dbf("Data/RV_CATCH.dbf")

# match spp names to codes 
RV.Catch <- left_join(RV.Catch, spp_codes, by=c("SPECIES" = "code"))

#number of sets
sets <- length(RV.SET)

#divisions surveyed
divs <- unique(RV.SET$NAFO_DIV)

#Depth range
depth.range <- range(as.numeric(as.character(RV.SET$MEAN_DEPTH)),na.rm=TRUE)

#Number of species encountered.
num.species <- length((unique(RV.Catch$SPECIES)))

#Total catch
total.catch <- RV.Catch %>% 
  summarise(total=sum(WEIGHTC))


```


<!--chapter:end:index.Rmd-->

## TRIP SUMMARY

**Vessel:** `r trip_sum[["Vessel"]]` |
**Trip number:** `r paste(trip_sum[["Vessel.abb"]],trip_sum[["Trip"]],collapse="")`
<!-- update your locations and dates here
-->

**Sailed from:** `r trip_sum[["Depart"]]`  |
**Returned to:** `r trip_sum[["Return"]]`

**Start Date:** `r trip_sum[["Start"]]` |
**End Date:** `r trip_sum[["End"]]`

**Scientific Staff:** `r trip_sum[["PIC"]]`(SIC), `r trip_sum[["Crew"]]`

**Area of Operation:** `r as.character(unique(RV.SET$NAFO_DIV))` fishing in depths to a maximum of `r max(as.numeric(as.character(RV.SET$MEAN_DEPTH)))` m.

**Purpose:** To determine the distribution and abundance of various groundfish and shellfish species with respect to position, depth and temperature and to collect biological samples.

**Fishing Methods:** Sets of 15-minute duration towing at 3.0 knots using the Campellen 1800 bottom trawl with a small-mesh liner (12 mm) in the cod-end. SCANMAR acoustic sensors were mounted on the trawl for determination of bottom contact and net configuration during tow.

**Time Lost:**
```{r Timelost, echo=FALSE}
library(kableExtra)

categories <- c("Mechanical Issues", "Weather", "Other")

mech <- 3 #enter the number of hours lost to "MEchanical Issues"
weather <- 5 #enter the number of hours lost to "Weather"
other <- 19 #enter the number of hours lost to "other" causes

time <- c(mech, weather, other)

time_lost <- data.frame(cbind(categories, time))
kable(time_lost, format="markdown", caption = "Time lost")

hourslost <- sum(as.numeric(as.character(time_lost$time)))

```

A total of `r hourslost` hours were lost due to a combination of weather, mecahanical issues and other causes.  <!-- can edit this text to add details on causes, lost time-->

``` {r successsets, echo=F}
RV.SET$set <- ifelse(RV.SET$DAMAGE==1, "successful", "unsuccessful")

num_sets <- RV.SET %>% 
  group_by(NAFO_DIV) %>% 
  group_by(set, add=T) %>% 
  summarize(N_sets=n())

colnames(num_sets) <- c("NAFO", "type","N")
kable(num_sets, format = "markdown", caption = "Successful sets by NAFO division")

sucessful <- RV.SET %>% 
  group_by(set, add=T) %>% 
  summarize(N_sets=n())

successfulsets <- sucessful[1,2]
unsuccessfulsets <- sucessful[2,2]

```

A total of `r successfulsets` successful sets and `r unsuccessfulsets` unsuccessful sets were completed between depths of `r min(as.numeric(as.character(RV.SET$MEAN_DEPTH)))` m and `r max(as.numeric(as.character(RV.SET$MEAN_DEPTH)))` m. 

<!--chapter:end:01TripSummary.Rmd-->

#SURVEY TRACK

```{r surveymap, include=FALSE, message=FALSE}
divs<-c("2G","2H")

packages <- c("ggmap", "rgdal", "rgeos", "maptools", "dplyr", "tidyr","sf","maps","plyr","wesanderson")

package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE)
    library(x, character.only = TRUE)
  }
})

pal <- wes_palette("Zissou1", 50, type = "continuous")

newfoundland_sp<-st_read("NL_shapefile/NL.shp")

strata<-st_read("DFO Strata Files/2HJ3KLNOP_Strata_Polygons_WGS84.shp")

strata_new<-strata[strata$DIV%in%divs,]#filters for the desired NAFO Divs

NAFO_div<-st_read("Divisions/Divisions.shp")
NAFO_div<-NAFO_div[NAFO_div$ZONE%in%divs,]

head(RV.SET)
RV.SET.trim<-RV.SET%>%
  select(SET,LAT_START,LONG_START,LAT_END,LONG_END)
RV_f<-data.frame(SET=RV.SET.trim$SET,apply(RV.SET.trim[,-1],2,function(x){
  res<-as.numeric(substr(x,1,2))+as.numeric(substr(x,3,6))/60
}))
RV_f <- RV_f%>%
  mutate(LONG_START=0-LONG_START)%>%
  mutate(LONG_END=0-LONG_END)

RV_sp<-  SpatialPointsDataFrame(coords = RV_f[,c("LAT_START","LONG_START","LAT_END","LONG_END")], data = RV_f,
                                proj4string = CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))

colnames(strata_new)[3]<-"strat"
```

```{r makeamap, echo=FALSE,fig.height = 6, fig.width = 5, fig.caption = "Figure 1: Survey track for multispecies survey"}

ggplot()+
    theme_classic()+
    geom_sf(data=strata_new)+#Empty Strata plotting
    annotate("text",RV_sp$LONG_START,RV_sp$LAT_START,label=RV_sp$SET,hjust=-.5)+
    geom_point(aes(LONG_START,LAT_START),RV_f)+
    geom_path(aes(LONG_START,LAT_START),RV_f,lwd=1)+
    geom_sf(data=(NAFO_div), colour="black", fill=NA, lwd=1)+#Add NAFO lines
    geom_sf(data=fortify(newfoundland_sp),fill="burlywood3")+#Add NL
    theme(panel.grid.major=element_line(colour="transparent"))+
    theme(plot.title = element_text(size=12,hjust = 0.5),
          plot.subtitle = element_text(size=12,hjust = 0.5))+
    coord_sf(xlim = c(st_bbox(strata_new)[1],st_bbox(strata_new)[3]),ylim = c(st_bbox(strata_new)[2],st_bbox(strata_new)[4]))

```


A plot of the survey track is presented in Figure @\ref(fig:makeamap).

<!--chapter:end:02-Map.Rmd-->



```{r catch.summary, include=FALSE}
library(tidyverse)

#  read in FFS data dbf      
RV.SET <- read.dbf("Data/RV_SET.dbf")
RV.Catch <- read.dbf("Data/RV_CATCH.dbf")

# match spp names to codes 
RV.Catch <- left_join(RV.Catch, spp_codes, by=c("SPECIES" = "code"))

#number of sets
sets <- length(RV.SET)

#divisions surveyed
divs <- unique(RV.SET$NAFO_DIV)

#Depth range
depth.range <- range(as.numeric(as.character(RV.SET$MEAN_DEPTH)),na.rm=TRUE)

#Number of species encountered.
num.species <- length((unique(RV.Catch$SPECIES)))

#Total catch
total.catch <- RV.Catch %>% 
  summarise(total=sum(WEIGHTC))
```

This trip completed `r sets` sets in NAFO divisions `r as.character(divs)`. Total catch was `r round (total.catch,0)`kg, with `r num.species` taxa recorded. Fishing occurred from `r min(depth.range)`m to `r max(depth.range)`m.
\

```{r top.catch, echo=FALSE}
library(tidyverse)

weight.sum <- RV.Catch %>% 
  group_by(Spc_Name) %>% 
  summarize(weight=sum(WEIGHTC)) %>% 
  arrange(desc(weight))

weight.sum$prop <- weight.sum$weight/total.catch$total

```
`r num.species` taxa were represented in the catch, with a total catch weight of `r total.catch`kg. `r as.character(weight.sum$Spc_Name[1])` and `r as.character(weight.sum$Spc_Name[2])` were the most prevalent species, accounting for `r round(weight.sum$prop[1]*100,1)`% and `r round(weight.sum$prop[1]*100,2)`% of the total catch by weight, respectively. Figure \@ref{catch.summary} summarizes the most commonly caught taxa from this trip.

Summarized near bottom temperature from a net mounted CTD is shown in Figure \@ref{temp.plot}.

```{r catch.plot, echo=FALSE, message=FALSE,fig.height = 5, fig.width = 7, fig.caption = "Total catch weight of the fifteen most commonly encountered taxa during trip `r trip"}
library(tidyverse)

RV.Catch %>% 
  group_by(SPECIES) %>% 
  summarize(weight=sum(WEIGHTC)) %>% 
  top_n(15) %>% 
  ggplot +
  geom_col(aes(x=reorder(SPECIES), -weight), y=weight)+
  scale_y_continuous(expand=c(0,0), limits=c(0,1500))+
  ylab("Total catch weight (kg)")+
  xlab("Species code")+
  theme_bw()+
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=12),
        plot.title = element_text(hjust = 0.5,size=14),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 20, b = 0, l = 0)),
        plot.margin=unit(c(0.25,1,0.5,0.25),"cm"),
        panel.border = element_rect(colour = "grey", fill=NA, size=0.75))
```


```{r temp.plot, echo=FALSE, message=FALSE, fig.height = 6, fig.width = 5, fig.caption = "Temperature at depth, as recorded from trawl mounted CTD"}
library(tidyverse)

RV.SET %>% 
  filter(FISH_TEMP<88) %>% 
  ggplot()+
  geom_point(aes(y=as.numeric(as.character(MEAN_DEPTH)), x=FISH_TEMP), size=2)+
  scale_y_reverse()+
  ylab("Depth (m)")+
  xlab("Temperature (°C)")+
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=12),
        plot.title = element_text(hjust = 0.5,size=14),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 20, b = 0, l = 0)),
        plot.margin=unit(c(0.25,1,0.5,0.25),"cm"),
        panel.border = element_rect(colour = "black", fill=NA, size=0.75))

```



This report has been prepared by `r trip_sum[["PIC"]]`(SIC).


<!--chapter:end:03-Catchsummary.Rmd-->

