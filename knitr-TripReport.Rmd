---
# This part is YAML (Yet Another Markup Language). To run this file do:
# rmarkdown::render("knitr-example-simpler.Rmd")
# or click "Knit" in RStudio
title: DFO Multispecies Survey Trip Report
subtitle: Newfoundland and Labrador Region
author: "Science Branch"
output: pdf_document
fontsize: 12pt

---

<!-- The following code contains text and code to summarize a multipspecies survey trip
-->

<!-- knitr options, adapted from gfsynopsis, and snatched from the 2018 TESA TTT workshop: -->
```{r setup, echo=FALSE, cache=FALSE, message=FALSE, results='hide', warning=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  # warning = FALSE,
  # message = FALSE,
  comment = "#>",
  fig.path = "knitr-figs/",
  cache.path = if (knitr:::is_latex_output()) "knitr-cache-tex/" else "knitr-cache-docx/",
  fig.asp = 0.618,
  fig.width = 9,
  out.width = "6in",
  echo = TRUE,
  autodep = TRUE,
  cache = TRUE,
  # cache.comments = FALSE,
  dev = if (knitr:::is_latex_output()) "pdf" else "png",
  dpi = 200,
  fig.align = "center",
  fig.pos = "htb"
)
```


```{r trip.settings, echo=FALSE}
SIC <- "Laura Wheeland" #scientist in charge name in quotes
vessel <- "Teleost" #enter your vessel name in the quotes
trip.no <- "190" #enter your trip number here
ves.code <- ifelse(vessel=="Teleost","TEL", "NED")
trip <- paste0(ves.code, trip.no) #enter your trip number. vessel carried from lines before
date_start <- "October 24, 2018"
date_end <- "November 6, 2018"
crew <- c("F. Dawson", "K. Rideout", "M. Terry", "B. Vaters", "P. Higdon", "J. Croft", "F. Tulk", "T. Bungay")
area <- "NAFO Divisions 2H and 2J"
```
## TRIP SUMMARY

**Vessel:** `r vessel` |
**Trip number:** `r trip`
<!-- update your locations and dates here
-->

**Sailed from:** St. Anthony, NL |
**Returned to:** St. John's, NL

<!-- **Start date:** October 24, 2018 | -->
<!-- **End date:** November 6, 2018 -->
**Start Date:** `r date_start`
**End Date:** `r date_end`

**Scientific Staff:** `r SIC`(SIC), `r crew`

This report has been prepared by `r SIC`(SIC).

**Area of Operation:**

**Purpose:**

**Fishing Methods:**




## Catch Summary

```{r catch.summary, include=FALSE}
library(tidyverse)
library(foreign)

#  read in species codes     
spp_codes <- read_csv("C:/Users/Laura/Documents/trip report/species codes (lookup).csv")
spp_codes$code <- as.numeric(spp_codes$Spc_Code)

#  read in FFS data dbf      
RV.SET <- read.dbf("C:/Users/Laura/Documents/trip report/TEL190/RV_SET.dbf")
RV.Catch <- read.dbf("C:/Users/Laura/Documents/trip report/TEL190/RV_CATCH.dbf")

# match spp names to codes 
RV.Catch <- left_join(RV.Catch, spp_codes, by=c("SPECIES" = "code"))

#number of sets
sets <- length(RV.SET)

#divisions surveyed
divs <- unique(RV.SET$NAFO_DIV)

#Depth range
depth.range <- range(as.numeric(as.character(RV.SET$MEAN_DEPTH)),na.rm=TRUE)

#Number of species encountered.
num.species <- length((unique(RV.Catch$SPECIES)))

#Total catch
total.catch <- RV.Catch %>% 
  summarise(total=sum(WEIGHTC))
```

This trip completed `r sets` sets in NAFO divisions `r as.character(divs)`. Total catch was `r round (total.catch,0)`kg, with `r num.species` taxa recorded. Fishing occurred from `r min(depth.range)`m to `r max(depth.range)`m.
\

<!--#plot catch weight of top 15 taxa-->
```{r catch.plot, echo=FALSE, message=FALSE}

top15 <- RV.Catch %>% 
  group_by(SPECIES) %>% 
  summarize(weight=sum(WEIGHTC)) %>% 
  top_n(15) %>% 
  ggplot +
  geom_col(aes(x=reorder(as.factor(SPECIES), -weight), y=weight))+
  scale_y_continuous(expand=c(0,0), limits=c(0,1500))+
  ylab("Total catch weight (kg)")+
  xlab("Species")+
  theme_bw()+
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=12),
        plot.title = element_text(hjust = 0.5,size=14),
        axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
        axis.title.x = element_text(margin = margin(t = 10, r = 20, b = 0, l = 0)),
        plot.margin=unit(c(0.25,1,0.5,0.25),"cm"),
        panel.border = element_rect(colour = "black", fill=NA, size=0.75))

top15
```

*Figure 1: Total catch weight of the fifteen most commonly encountered taxa during trip `r trip`*

<!-- TABLE OF SETS -->
```{r Sets.Table, echo=FALSE}

n_sets <- RV.SET %>% 
  group_by(depth.bin) %>% 
  summarize(N=n()) 


```
kable(n_sets, format="markdown")

